# ç”¨æœºå™¨å­¦ä¹ åšä¸ªè‰ºæœ¯ç”»å®¶-Prisma

ä½œè€…ï¼šé˜¿å¸ƒğŸ¶

å¾®ä¿¡ï¼šaaaabbbuu

æœªç»æœ¬äººå…è®¸ç¦æ­¢è½¬è½½

[youku é˜¿å¸ƒPrismaæ¼”ç¤ºè§†é¢‘](http://v.youku.com/v_show/id_XMTg0MDE3NTM3Mg==.html)

[æ›´å¤šé£æ ¼å›¾åƒå±•ç¤ºå¢™](http://www.yabeetu.com/)


[ç”¨æœºå™¨å­¦ä¹ åšä¸ªè‰ºæœ¯ç”»å®¶ ä¸Š](http://www.jianshu.com/p/64a3b4e3f548)

[ç”¨æœºå™¨å­¦ä¹ åšä¸ªè‰ºæœ¯ç”»å®¶ ä¸­](http://www.jianshu.com/p/2bd096179dd8)

[ç”¨æœºå™¨å­¦ä¹ åšä¸ªè‰ºæœ¯ç”»å®¶ ä¸‹](http://www.jianshu.com/p/e1629d69a66a)



____

éœ€ä¸‹è½½ä¸‹é¢çš„æ¨¡å‹æ”¾å…¥modeæ–‡ä»¶å¤¹ä¸­ï¼š

1. [bvlc_googlenet.caffemodel](https://pan.baidu.com/s/1i5NosiL)æ˜¯googleå·²ç»è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œå¯ä»¥é€šè¿‡æˆ‘çš„ç½‘ç›˜é“¾æ¥ä¸‹è½½ï¼Œæå–ç ä¸ºeup6
2.  [K_VGG_MAT_PATH = '../mode/vgg_imagenet.mat'](https://pan.baidu.com/s/1bpssvPP)æ˜¯vggæ¨¡å‹ï¼Œå¯ä»¥é€šè¿‡æˆ‘çš„ç½‘ç›˜é“¾æ¥ä¸‹è½½ï¼Œæå–ç ä¸ºgunt

ä¸‹é¢çš„readmeæ˜¯ ç”¨æœºå™¨å­¦ä¹ åšä¸ªè‰ºæœ¯ç”»å®¶(ä¸­)

ä¸Šä¸€ç« ä½¿ç”¨çš„ä¸¤ç§æ–¹å¼å®ç°prismaï¼Œéƒ½å­˜åœ¨é—®é¢˜ï¼Œè¿™ç« è¦ä½¿ç”¨çš„æ–¹å¼æ˜¯æˆ‘è‡ªå·±åŸåˆ›çš„æ–¹æ³•ï¼Œæˆ‘å®é™…ä¸Šå¹¶ä¸çŸ¥é“prismaåˆ°åº•ä½¿ç”¨äº†ä»€ä¹ˆæ–¹å¼ä½¿å›¾åƒæ•ˆæœåˆå¥½ï¼Œé€Ÿåº¦åˆå¿«ï¼Œä½†æ˜¯å¤§æ¦‚çŒœæµ‹çš„æ–¹å‘ä¹Ÿå°±è¿™å‡ ç§å¯èƒ½ï¼š

1. å¤§é‡çš„å¤šcpuï¼Œgpuçš„æœºå™¨ï¼ˆç»å¯¹ä¸ç°å®ï¼Œæˆæœ¬æ ¹æœ¬æ— æ³•æ§åˆ¶ï¼‰
2. ä¼˜åŒ–ç®—æ³•ï¼Œä¼˜åŒ–ç½‘ç»œæ¡†æ¶ï¼ˆå°±ç®—æ˜¯è¿™æ ·ï¼Œæˆ‘æ²¡èƒ½åŠ›åœ¨è¿™æ–¹é¢ä¼˜åŒ–ğŸ™ˆï¼‰
3. æ‹¥æœ‰å¾ˆå¤§çš„å›¾åƒæ•°æ®åº“ï¼Œå¯ä»¥å¾ˆå¿«çš„æ£€ç´¢å‡ºä¸è¾“å…¥å›¾åƒç›¸ä¼¼åº¦æœ€é«˜çš„å›¾åƒï¼Œä¹‹åç›¸ä¼¼ç‰¹å¾æå–æƒé‡æ¸²æŸ“ï¼ˆæˆ‘æ²¡èµ„æºï¼Œè€Œä¸”è¿™ç§æ–¹å¼çš„ç“¶é¢ˆåœ¨æ£€ç´¢å’Œç›¸ä¼¼åº¦è®¡ç®—ä¸Šä¹Ÿå¾ˆæ¶ˆè€—èµ„æºï¼Œåªæ˜¯ä¸€ç§å¯èƒ½ï¼‰
4. é’ˆå¯¹å›¾åƒéƒ¨åˆ†ä½¿ç”¨æœºå™¨å­¦ä¹ ç®—æ³•ç‰¹å¾å±‚æ”¾å¤§ï¼Œéƒ¨åˆ†ä½¿ç”¨ä¸€äº›å›¾åƒå¤„ç†æŠ€æœ¯ï¼Œæå‡æ¸²æŸ“é€Ÿåº¦

æˆ‘ä¸‹é¢è®²çš„å†…å®¹æ˜¯é’ˆå¯¹ç¬¬å››ç‚¹å±•å¼€è¯•éªŒçš„ï¼Œå¯ä»¥åœ¨é€Ÿåº¦åŠæ¸²æŸ“æ•ˆæœä¸Šéƒ½èƒ½è¾¾åˆ°æ¯”è¾ƒæ»¡æ„çš„æ•ˆæœï¼Œå› ä¸ºé€Ÿåº¦ä¸Šå¯ä»¥å¿½ç•¥ï¼Œæ•ˆæœè¿˜æŒºå¥½ï¼Œå”¯ä¸€çš„ç¼ºé™·å°±æ˜¯åœ¨é€‚ç”¨æ€§ä¸Šå¯èƒ½ä¼šéœ€è¦è°ƒæ•´ä¸€ä¸‹å‚æ•°ï¼ˆåœ¨é€‚ç”¨æ€§ä¸Šå¯ä»¥ç»“åˆä¸Šè¿°ç¬¬ä¸‰ç§æ–¹å¼ï¼Œé’ˆå¯¹ä¸€å®šæ•°é‡çš„æ ·æœ¬ä½œä¸ºè®­ç»ƒé›†xï¼Œå¯¹åº”çš„yæ˜¯æ•ˆæœå‚æ•°ï¼Œå¯¹è¾“å…¥è¿›è¡Œåˆ†ç±»ï¼Œå†é…åˆä½¿ç”¨ç›¸ä¼¼åº¦ç­‰æé«˜è‡ªåŠ¨é€‚é…çš„èƒ½åŠ›ï¼‰

å¦‚ä¸‹åœ°å€ä¸ºgitä¸Šé¡¹ç›®çš„æœ€ç»ˆæ¼”ç¤ºä½¿ç”¨è§†é¢‘ï¼Œä½¿ç”¨æœ¬ç« ä»‹ç»çš„æŠ€æœ¯å®ç°ï¼Œå¯ä»¥å…ˆæœ‰ä¸ªç›´è§‚æ„Ÿå—
[youku é˜¿å¸ƒPrismaæ¼”ç¤ºè§†é¢‘](http://v.youku.com/v_show/id_XMTg0MDE3NTM3Mg==.html)
[æ›´å¤šé£æ ¼å›¾åƒå±•ç¤ºå¢™](http://www.yabeetu.com/)
[é¡¹ç›®gitåœ°å€](https://github.com/bbfamily/prisma_abu)

### 1 ä¸»è¦å®ç°æ€è·¯åˆ†è§£è®²è§£

æˆ‘è¿˜æ˜¯ä½¿ç”¨abu1è¿™å¼ å›¾ç‰‡ä½œä¸ºè¾“å…¥


```python
from __future__ import division
import matplotlib.pylab as plt
%matplotlib inline

import os
from PrismaCaffe import CaffePrismaClass
import PrismaHelper
import glob
import numpy as np
import PIL.Image
import ZCommonUtil
import itertools
from functools import partial
abu1_file = '../sample/abu1.jpg'
cp  = CaffePrismaClass(dog_mode=False)
PrismaHelper.show_array_ipython(np.float32(cp.resize_img(PIL.Image.open(abu1_file))))
```


![](http://upload-images.jianshu.io/upload_images/3136804-d71c5139e2cda0b6.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



ç„¶åæŒ‘ä¸€å¼ å¼•å¯¼ç‰¹å¾å›¾åƒ


```python
gd_path = '../prisma_gd/tooopen_sy_127260228921.jpg'
guide_img = np.float32(cp.resize_img(PIL.Image.open(gd_path), base_width=480, keep_size=False))
PrismaHelper.show_array_ipython(guide_img)
```


![](http://upload-images.jianshu.io/upload_images/3136804-40db8fb93dc6e428.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



å¯¼å…¥ä¸€äº›ç›¸å…³å›¾åƒå¤„ç†çš„åŸºç¡€åŒ…


```python
from skimage import filters
from skimage import segmentation
from skimage.feature import corner_harris, corner_subpix, corner_peaks
from scipy.signal import convolve2d
from scipy import ndimage
from scipy import misc
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé¦–å…ˆå°†å›¾åƒè½¬åŒ–ä¸ºå•é€šé“ï¼Œç”¨otsuå¯»æ‰¾mask, é€šè¿‡maskç¡®å®šborderå’Œedges 

å¤‡æ³¨ï¼š
otsu(å¤§æ´¥ç®—æ³•, è‡ªé€‚åº”é˜ˆå€¼)

* [å…³äºskimage otsuç­‰ä½¿ç”¨è¯·å‚è€ƒ](http://scikit-image.org/)
* [å…³äºscipy ndimageç­‰ä½¿ç”¨è¯·å‚è€ƒ](https://docs.scipy.org)


```python
r_img = cp.resize_img(PIL.Image.open(abu1_file), base_width=480, keep_size=False)
# rgbè½¬åŒ–ä¸ºå•é€šé“ç°é˜¶å›¾åƒ
l_img = np.float32(r_img.convert('L'))
# filters.threshold_otsuéœ€è¦ï¼1ï¼Œ 1ä¹‹é—´
l_img = np.float32(l_img / 255) 
r_img = np.float32(r_img)

# æ‰¾å‡ºå¤§äºotsuçš„é˜€å€¼ä½œä¸ºmaskï¼Œéœ€æ‰¾border
mask = l_img > filters.threshold_otsu(l_img)
# ä¸æ˜¯é€‚ç”¨æ‰€æœ‰å›¾åƒéƒ½è¦clear borderï¼Œæ¯”å¦‚å›¾åƒä¸»é¢˜å¤§éƒ¨åˆ†æ˜¯éœ€è¦ä¿ç•™å°±ä¸éœ€è¦
clean_border = segmentation.clear_border(mask).astype(np.int)
coins_edges = segmentation.mark_boundaries(l_img, clean_border)
# å°†å€¼å†æ¬¡è½¬æ¢åˆ°0-255
clean_border_img = np.float32(clean_border * 255)
clean_border_img = np.uint8(np.clip(clean_border_img, 0, 255))

PrismaHelper.show_array_ipython(clean_border_img)
```



![](http://upload-images.jianshu.io/upload_images/3136804-420c0570cb714d2d.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



ç›®æ ‡å°±æ˜¯åªæƒ³æ‘˜å–é˜¿å¸ƒçš„å›¾åƒï¼Œå…¶å®ƒçš„éƒ½è®¤ä¸ºæ˜¯å™ªéŸ³ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ndimage.binary_openingè¾¾åˆ°æ•ˆæœå—ï¼Œè¯•è¯•çœ‹


```python
clean_border_img = ndimage.binary_opening(np.float32(clean_border_img / 255), structure=np.ones((5,5))).astype(np.int)
clean_border_img = ndimage.binary_opening(clean_border_img).astype(np.int)
PrismaHelper.show_array_ipython(clean_border_img * 255)
```


![](http://upload-images.jianshu.io/upload_images/3136804-ca873ee5c3d27c12.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



æ•ˆæœå…¶å®ä¸å¤ªå¥½ï¼Œndimage.binary_openingæ•ˆæœä¸cnnä¸­çš„æœ€å°æ± åŒ–å±‚ç›¸ä¼¼ï¼Œç›®çš„å°±æ˜¯remove small objectï¼Œæˆ‘ä»¬ä¸‹é¢é€šè¿‡è‡ªå®šä¹‰ç®€å•å·ç§¯æ ¸æ¥è¿‡æ»¤ï¼Œå®ç°æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä»£ç å¦‚ä¸‹


```python
# æœ€å°çš„å·ç§¯æ ¸ç›®çš„æ˜¯ä¿ç•™å¤§ä½“å›¾åƒç»“æ„
n= 5
small_window = np.ones((n, n))
small_window /= np.sum(small_window)
clean_border_small = convolve2d(clean_border_img, small_window, mode="same", boundary="fill")

# ä¸­å·çš„å·ç§¯æ ¸æ˜¯ä¸ºäº†ä¿ç•™å›¾åƒçš„å†…åµŒéƒ¨åˆ†ï¼Œè¿™é‡Œçš„ä½œç”¨å°±æ˜¯é˜¿å¸ƒçš„é»‘é¼»å­å’Œå˜´é‚£éƒ¨åˆ†ï¼Œå¦‚æœæ²¡æœ‰è¿™å±‚ï¼Œå°±æ— æ³•ä¿ç•™
n= 25
median_window = np.ones((n, n))
median_window /= np.sum(median_window)
clean_border_convd_median = convolve2d(clean_border_img, median_window, mode="same", boundary="fill")

# æœ€å¤§å·çš„å·ç§¯æ ¸ï¼Œåªæ˜¯ä¸ºäº†å»é™¤æ•£è½çš„è¾¹ç¼˜ï¼Œå¾ˆå¤šæ—¶å€™æ²¡æœ‰å¿…è¦ï¼Œå½±å“é€Ÿåº¦å’Œæ•ˆæœ
n= 180
big_window = np.ones((n, n))
big_window /= np.sum(big_window)
clean_border_convd_big = convolve2d(clean_border_img, big_window, mode="same", boundary="fill")

l_imgs = []
for d in range(3):
    # åˆ†åˆ«å¯¹rgbä¸‰ä¸ªé€šé“è¿›è¡Œæ»¤æ³¢
    rd_img = r_img[:,:,d]
    gd_img = guide_img[:,:,d]
    # ç¬¦åˆä¿ç•™æ¡ä»¶çš„ä½¿ç”¨åŸå§‹å›¾åƒï¼Œå¦åˆ™ä½¿ç”¨ç‰¹å¾å›¾åƒ
    d_img = np.where(np.logical_or(clean_border_convd_median > 5 * clean_border_convd_big.mean(), 
            np.logical_and(clean_border_small > 0, clean_border_convd_big > 2 * clean_border_convd_big.mean())), 
            rd_img, gd_img)
    l_imgs.append(d_img)
img_cvt = np.stack(l_imgs, axis=2).astype("uint8")
# å¯¹è½¬æ¢å‡ºçš„å›¾åƒè¿›è¡Œä¸€æ¬¡ç®€å•æµ…å±‚ç‰¹å¾æ”¾å¤§
d_img = cp.fit_img(nbk='conv2/3x3_reduce', iter_n=10, img_np=img_cvt)
PrismaHelper.show_array_ipython(np.float32(d_img))
```

![](http://upload-images.jianshu.io/upload_images/3136804-eed88357c30899bf.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



[é£æ ¼å›¾åƒå±•ç¤ºå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODA4NTczNDkuNzYwLjQzNzcwNTI4MTgwMy8uL2N2dC5qcGc=)

ä»£ç å¹¶ä¸å¤šï¼Œä¸»è¦æ€è·¯å¦‚ä¸‹ï¼š

1. é€šè¿‡filters.threshold_otsuæ‰¾å‡ºå›¾åƒçš„mask
2. segmentation.clear_border(mask)æŠ½å–å›¾åƒborder, edges
3. ä½¿ç”¨ä¸‰ä¸ªå·ç§¯æ ¸å¯¹å›¾åƒè¿›è¡Œæ»¤æ³¢å¤„ç†ï¼Œè¿™é‡Œçš„ä¸‰ä¸ªå·ç§¯æ ¸çš„åˆ†å·¥è¯·çœ‹ä¸Šé¢ä»£ç æ³¨é‡Šï¼Œè¿™é‡Œçš„æ»¤æ³¢æ˜¯å°±æ˜¯å¼•å¯¼ç‰¹å¾å’ŒåŸå§‹å›¾åƒçš„æƒé‡åˆ†é…

å·ç§¯çš„æ„ä¹‰ç®€å•ç†è§£å°±æ˜¯**åŠ æƒå åŠ **, é’ˆå¯¹è¾“å…¥çš„å•ä½ç›¸åº”å¾—åˆ°è¾“å‡ºï¼Œä¸ºä»€ä¹ˆè¦ç”¨å·ç§¯å‘¢ï¼Œå…¶å®å°±æ˜¯ä¸ºäº†æ•ˆç‡ï¼Œå¦‚æœä¸Šé¢çš„ä»£ç ä½ ä»ç›®çš„å‡ºå‘ï¼ŒçŸ¥é“è¦æ»¤é™¤ä»€ä¹ˆæ ·çš„åƒç´ ç‚¹ï¼Œä¿ç•™ä»€ä¹ˆæ ·çš„åƒç´ ç‚¹ï¼Œä½¿ç”¨forå¾ªç¯é’ˆå¯¹æ¯ä¸€ä¸ªåƒç´ ç‚¹ï¼Œè®¡ç®—åƒç´ ç‚¹ä¸€å®šèŒƒå›´å†…ï¼ˆä¸Šé¢è¯´çš„æ ¸å¤§å°ï¼‰ä½¿ç”¨forå¾ªç¯ä¸€æ­¥ä¸€æ­¥çš„å‰è¿›ï¼Œä½ å…¶å®ä¹Ÿèƒ½å¾—å‡ºç»“æœï¼Œä½†æ˜¯è¿ç®—çš„æ—¶é—´å¤æ‚åº¦å°†å¤§å‡ºå‡ ä¸ªæ•°é‡çº§ï¼Œè¿™å°±ç±»ä¼¼å¾ˆå¤šæœ€ä¼˜é—®é¢˜ä½ å¯ä»¥ä½¿ç”¨è’™ç‰¹å¡æ´›æ–¹æ³•æ±‚æœ€ä¼˜è§£ï¼Œä½†æ˜¯ç”±äºè®¡ç®—é‡å¤ªå¤§ï¼Œå®é™…ä¸Šæ— æ³•åšåˆ°éå†æ‰€æœ‰è·¯å¾„ï¼Œæ‰€ä»¥æ‰ä¼šä½¿ç”¨å‡¸ä¼˜åŒ–ç­‰æ•°å­¦æ–¹å¼æ±‚æœ€ä¼˜è§£ï¼Œå¹¶ä¸”å¾ˆå¤šæ—¶å€™ä¹Ÿæ˜¯å…ˆæ±‚ä¸ªå¤§æ¦‚çš„å…¨å±€æœ€ä¼˜ï¼Œç„¶ååœ¨è¿™ä¸ªå…¨å±€æœ€ä¼˜çš„åŸºç¡€ä¸Šæ±‚è§£å±€éƒ¨æœ€ä¼˜è§£ã€‚

å¦å¤–é’ˆå¯¹caffeåŠtensorflowçš„ä¸€äº›ä½¿ç”¨é—®é¢˜å¯ä»¥æŸ¥çœ‹æˆ‘çš„å…¶å®ƒä¸¤ç¯‡æ–‡ç« :
[æ‰“å¼€è‚¡ç¥¨é‡åŒ–çš„é»‘ç®±(è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº) ç¬¬ä¸‰ç« ](http://www.jianshu.com/p/056d8b28f581)
[ æˆ–è€…å…³æ³¨ è‚¡ç¥¨é‡åŒ–ä¸“é¢˜](http://www.jianshu.com/collection/0a774f78050a)
[çˆ¬å–ç™¾åº¦å›¾ç‰‡å„ç§ç‹—ç‹—çš„å›¾ç‰‡ï¼Œä½¿ç”¨caffeè®­ç»ƒæ¨¡å‹åˆ†ç±»](http://www.jianshu.com/p/6942241d4ad9)
[ æˆ–è€…å…³æ³¨ æœºå™¨å­¦ä¹ ä¸“é¢˜](http://www.jianshu.com/collection/7c9da6c79a89)

**æ›´å¤šå…³äºæ·±åº¦å­¦ä¹ ç†è®ºåŠå®ä¾‹è¯·å…³æ³¨æˆ‘å°†å‡ºç‰ˆçš„ä¸€æœ¬å…³äºæ·±åº¦å­¦ä¹ æ–¹é¢çš„ä¹¦ç±**

### 2. ä½¿ç”¨å›¾åƒç‰¹å¾ä½œä¸ºmask

ä¸Šé¢çš„æ–¹æ³•ä½¿ç”¨otsuå¯»æ‰¾å›¾åƒè¾¹ç¼˜ä½œä¸ºmaskçš„ä¾æ®ï¼Œä¸‹é¢æˆ‘ä½¿ç”¨skimageä¸­çš„corner_peaksæŠ½å–**å›¾åƒç‰¹å¾**ä½œä¸ºmask


```python
def show_features(gd_file):
    r_img = cp.resize_img(PIL.Image.open(gd_file), base_width=480, keep_size=False)
    l_img = np.float32(r_img.convert('L'))
    ll_img = np.float32(l_img / 255)
    
    coords = corner_peaks(corner_harris(ll_img), min_distance=5)
    coords_subpix = corner_subpix(ll_img, coords, window_size=25)

    plt.figure(figsize=(8, 8))
    plt.imshow(r_img, interpolation='nearest')
    plt.plot(coords_subpix[:, 1], coords_subpix[:, 0], '+r', markersize=15, mew=5)
    plt.plot(coords[:, 1], coords[:, 0], '.b', markersize=7)
    plt.axis('off')
    plt.show()
    
def find_features(gd_file=None, r_img=None, l_img=None, loop_factor=1, show=False):
    if gd_file is not None:
        r_img = cp.resize_img(PIL.Image.open(gd_file), base_width=480, keep_size=False)
        l_img = np.float32(r_img.convert('L'))
        l_img = np.float32(l_img / 255)
    
    coords = corner_peaks(corner_harris(l_img), min_distance=5)
    coords_subpix = corner_subpix(l_img, coords, window_size=25)
    
    r_img_copy = np.zeros_like(l_img)
    rd_img = np.float32(r_img)

    r_img_copy[coords[:, 0], coords[:, 1]] = 1
    
    f_loop = int(rd_img.shape[1]/10 * loop_factor)
    for _ in np.arange(0, f_loop):
        """
            æ”¾å¤§ç‰¹å¾ç‚¹ï¼Œä½¿ç”¨loop_factoræ¥æ§åˆ¶ç‰¹å¾æ”¾å¤§å€æ•°
        """
        r_img_copy = ndimage.binary_dilation(r_img_copy).astype(r_img_copy.dtype)
    r_img_copy_ret = r_img_copy * 255
    
    if show:
        r_img_copy_d = [rd_img[:,:,d] * r_img_copy for d in range(3)]
        r_img_copy = np.stack(r_img_copy_d, axis=2)
        PrismaHelper.show_array_ipython(r_img_copy) 
    return r_img_copy_ret
```

å¦‚ä¸‹æ˜¾ç¤ºçš„å›¾æŠ½å–å‡ºå›¾åƒç‰¹å¾ç‚¹


```python
show_features('../prisma_gd/71758PICxSa_1024.jpg')
```


![](http://upload-images.jianshu.io/upload_images/3136804-ee398eb6d90fc117.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


find_featuresä½¿ç”¨ndimage.binary_dilationæ¥**æ”¾å¤§**ç‰¹å¾ç‚¹ï¼Œä½¿ç”¨loop_factoræ¥æ§åˆ¶ç‰¹å¾æ”¾å¤§å€æ•°ï¼Œç›®çš„æ˜¯ç»“åˆå¼•å¯¼ç‰¹å¾åšæ¸²æŸ“æ—¶æå‡åŸå§‹å›¾åƒçš„ç‰¹å¾æƒé‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºfind_featuresæå–åçš„ç»“æœ


```python
_ = find_features('../prisma_gd/71758PICxSa_1024.jpg', loop_factor=1, show=True)
```



![](http://upload-images.jianshu.io/upload_images/3136804-1ad1ae2f07574b7d.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



ä¸‹é¢ç”¨ipython notebookçš„å¯äº¤äº’å½¢å¼æ›´ç›´è§‚çš„çœ‹ä¸€ä¸‹ç‰¹å¾çš„æŠ½å–ä¸æ”¾å¤§


```python
from ipywidgets import interact
def find_features_interact(gd_file, loop_factor):
    r_img = cp.resize_img(PIL.Image.open(gd_file), base_width=480, keep_size=False)
    l_img = np.float32(r_img.convert('L'))
    l_img = np.float32(l_img / 255)
    
    coords = corner_peaks(corner_harris(l_img), min_distance=5)
    coords_subpix = corner_subpix(l_img, coords, window_size=25)
    
    r_img_copy = np.zeros_like(l_img)
    rd_img = np.float32(r_img)

    r_img_copy[coords[:, 0], coords[:, 1]] = 1
    
    f_loop = int(rd_img.shape[1]/10 * loop_factor)
    for _ in np.arange(0, f_loop):
        """
            æ”¾å¤§ç‰¹å¾ç‚¹ï¼Œä½¿ç”¨loop_factoræ¥æ§åˆ¶ç‰¹å¾æ”¾å¤§å€æ•°
        """
        r_img_copy = ndimage.binary_dilation(r_img_copy).astype(r_img_copy.dtype)
    r_img_copy_ret = r_img_copy * 255
    
    r_img_copy_d = [rd_img[:,:,d] * r_img_copy for d in range(3)]
    r_img_copy = np.stack(r_img_copy_d, axis=2)
    PrismaHelper.show_array_ipython(r_img_copy) 
gd_file = ('../prisma_gd/71758PICxSa_1024.jpg', '../prisma_gd/st.jpg', '../prisma_gd/g1.jpg', '../prisma_gd/31K58PICSuH.jpg')
loop_factor = (0, 2, 0.1)
interact(find_features_interact, gd_file=gd_file, loop_factor=loop_factor)
```

å¦‚æœä¸æ˜¯ä½¿ç”¨ipython notebookç‰ˆæœ¬çš„å¯ä»¥ä¸‹è½½gifçœ‹æ•ˆæœ [ä¸‹è½½åœ°å€](https://github.com/bbfamily/monitor_parallel/blob/master/ft.gif)

### 3. ä½¿ç”¨ç»Ÿè®¡å‚æ•°æœŸæœ›ä¸æ ‡å‡†å·®å¯»æ‰¾mask

maskçš„æŠ½å–æ–¹æ³•å¯ä»¥æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œæ¯”å¦‚æˆ‘ä¸‹é¢è¿™è‚¡ç¥¨é‡åŒ–ç»Ÿè®¡ä¸­ç»å¸¸ä½¿ç”¨çš„å‡å€¼å›å¤åˆ†æï¼Œä½¿ç”¨å›¾åƒçš„å‡å€¼å’Œæ ‡å‡†å·®æ¥åšæ»¤æ³¢å™¨ï¼Œæå–å›¾åƒçš„mask
ä¸‹å›¾æ˜¯è‚¡ç¥¨é‡åŒ–ä¸­å‡å€¼å›å¤ç­–ç•¥å›¾ï¼Œå¯¹è‚¡ç¥¨é‡åŒ–æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„æ–‡ç« [æ‰“å¼€è‚¡ç¥¨é‡åŒ–çš„é»‘ç®±](http://www.jianshu.com/p/4ba3a10ea9e5)

ä¸‹é¢æˆ‘ä»¬é‡æ„ä¸€ä¸‹ä»£ç ï¼Œåˆ†åˆ«ä½¿ç”¨ä¸‰ç§æ»¤æ³¢å›¾åƒçš„æ–¹å¼ç”ŸæˆmaskæŸ¥çœ‹æ•ˆæœ

1. def do_otsu(r_img, l_img, cb)(æœ€å¼€å§‹ä»‹ç»çš„æ–¹å¼çš„ä»£ç å°è£…)
2. def do_features(r_img, l_img, cb, loop_factor=1.0)(ä¸Šé¢ä»‹ç»çš„é‚£ç§æŠ½å–å›¾åƒç‚¹é›†ç‰¹å¾æ”¾å¤§çš„æ–¹å¼)
3. def do_stdmean(r_img, l_img, cb, std_factor=1.0): (å‡å€¼æ ‡å‡†å·®ç»Ÿè®¡æ–¹å¼æŠ½å–mask)


![output_23_0.png](http://upload-images.jianshu.io/upload_images/3136804-5b5ee6b284e6383f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


### 4. ä½¿ç”¨å¤šç§æ–¹å¼prismaå›¾åƒ


```python
def do_otsu(r_img, l_img, cb, dd=True):
    mask = l_img > filters.threshold_otsu(l_img) if dd else l_img < filters.threshold_otsu(l_img)
    clean_border = mask
    if cb:
        clean_border = segmentation.clear_border(mask).astype(np.int)
    clean_border_img = np.float32(clean_border * 255)
    clean_border_img = np.uint8(np.clip(clean_border_img, 0, 255))
    return clean_border_img

def do_features(r_img, l_img, cb, loop_factor=1.0):
    mask = find_features(r_img=r_img, l_img=l_img, loop_factor=loop_factor)
    clean_border = mask
    if cb:
        clean_border = segmentation.clear_border(mask).astype(np.int)
    clean_border_img = np.float32(clean_border * 255)
    clean_border_img = np.uint8(np.clip(clean_border_img, 0, 255))
    return clean_border_img


"""
    å¯ä»¥ç»“åˆä¸Šé¢è‚¡ç¥¨çš„å›¾æ„Ÿå—ä¸€ä¸‹å›¾åƒæ»¤æ³¢çš„éƒ¨åˆ†
"""
def do_stdmean(r_img, l_img, cb, std_factor=1.0):
    mean_img = l_img.mean()
    std_img = l_img.std()
    
    mask1 = l_img > mean_img + (std_img * std_factor)
    mask2 = l_img < mean_img - (std_img * std_factor)
    
    clean_border = mask1
    if cb:
        clean_border = segmentation.clear_border(mask1).astype(np.int)
    clean_border_img1 = np.float32(clean_border * 255)
    clean_border_img1 = np.uint8(np.clip(clean_border_img1, 0, 255))
    
    clean_border = mask2
    if cb:
        clean_border = segmentation.clear_border(mask2).astype(np.int)
    clean_border_img2 = np.float32(clean_border * 255)
    clean_border_img2 = np.uint8(np.clip(clean_border_img2, 0, 255))
    
    # ä¸Šä¸‹ä¸¤éƒ¨åˆ†ç»„åˆ
    clean_border_img = clean_border_img1 + clean_border_img2
    clean_border_img = np.uint8(np.clip(clean_border_img, 0, 255))
    
    return clean_border_img

"""
    å°†å¤šä¸ªmask funcç»„åˆä¸çš„å½¢å¼ï¼Œç»„åˆmaskæ»¤æ³¢å™¨
    exp: tgt_mask_func = partial(together_mask_func, func_list=[do_otsu, mask_stdmean_func, mask_features_func])
"""
def together_mask_func(r_img, l_img, cb, func_list):
    clean_border_img = None
    for func in func_list:
        if not callable(func):
            raise TypeError("together_mask_func must a func!!!")
        border_img = func(r_img, l_img, cb)
        if clean_border_img is None:
            clean_border_img = border_img
        else:
            clean_border_img = clean_border_img + border_img
    clean_border_img = np.uint8(np.clip(clean_border_img, 0, 255))
    return clean_border_img
    
    
"""
    ä½¿ç”¨partialç»Ÿä¸€maskå‡½æ•°æ¥å£å½¢å¼
"""
mask_stdmean_func = partial(do_stdmean, std_factor=1.0)
mask_features_func = partial(do_features, loop_factor=0.88)

def do_convd_filter(n1, n2, n3, rb_rate, r_img, guide_img, clean_border_img, convd_median_factor, convd_big_factor):
    n= n1
    small_window = np.ones((n, n))
    small_window /= np.sum(small_window)
    clean_border_small = convolve2d(clean_border_img, small_window, mode="same", boundary="fill")

    n= n2
    median_window = np.ones((n, n))
    median_window /= np.sum(median_window)
    clean_border_convd_median = convolve2d(clean_border_img, median_window, mode="same", boundary="fill")

    n= n3
    big_window = np.ones((n, n))
    big_window /= np.sum(big_window)
    clean_border_convd_big = convolve2d(clean_border_img, big_window, mode="same", boundary="fill")

    l_imgs = []
    for d in range(3):
        """
            é’ˆå¯¹rgbå„ä¸ªé€šé“å¤„ç†
        """
        rd_img = r_img[:,:,d]
        gd_img = guide_img[:,:,d]
        
        wn = []
        for _ in np.arange(0, rd_img.shape[1]):
            """
                äºŒé¡¹å¼æ¦‚ç‡åˆ†å¸ƒ
            """
            wn.append(np.random.binomial(1, rb_rate, rd_img.shape[0]))
        if rb_rate <> 1:
            """
                é’ˆå¯¹rgbé€šé“é˜¶æ¢¯ä¸‹é™äºŒé¡¹å¼æ¦‚ç‡
            """
            rb_rate = rb_rate - 0.1
        w = np.stack(wn, axis=1)

        d_img = np.where(np.logical_or(
                         np.logical_and(clean_border_convd_median > convd_median_factor * clean_border_convd_big.mean(), w == 1),
                         np.logical_and(np.logical_and(clean_border_small > 0, w == 1), 
                                        clean_border_convd_big > convd_big_factor * clean_border_convd_big.mean(), 
                                        )), 
                         rd_img, gd_img)
    
        l_imgs.append(d_img)
    img_cvt = np.stack(l_imgs, axis=2).astype("uint8")
    return img_cvt
    
def mix_mask_with_convd(do_mask_func, org_file=None, gd_file=None, nbk=None, enhance=None, n1=5, n2=38, n3=1, 
                        convd_median_factor=5.0, convd_big_factor=0.0, cb=False, 
                        rb_rate=1, r_img=None, guide_img=None, all_mask=False, show=False):
    if r_img is None:
        r_img = cp.resize_img(PIL.Image.open(org_file), base_width=480, keep_size=False)
        
    l_img = np.float32(r_img.convert('L'))
    l_img = np.float32(l_img / 255) 
    r_img = np.float32(r_img)
    
    if show:
        PrismaHelper.show_array_ipython(np.float32(r_img))
        
    if not callable(do_mask_func):
        raise TypeError('mix_mask_with_convd must do_mask_func a func')

    clean_border_img = np.ones_like(l_img) * 255 if all_mask else do_mask_func(r_img=r_img, l_img=l_img, cb=cb)

    if show:
        PrismaHelper.show_array_ipython(np.float32(clean_border_img))
    
    if guide_img is None:
        if gd_file is not None:
            guide_img = np.float32(cp.resize_img(PIL.Image.open(gd_file), base_width=480, keep_size=False))
        else:
            guide_img = np.zeros_like(r_img)

    img_cvt = do_convd_filter(n1, n2, n3, rb_rate, r_img, guide_img, clean_border_img, 
                              convd_median_factor=convd_median_factor, convd_big_factor=convd_big_factor)
        
    if nbk is not None:
        img_cvt = cp.fit_img(org_file, nbk=nbk, iter_n=10, enhance=enhance, img_np=img_cvt)
    
    if show:
        PrismaHelper.show_array_ipython(np.float32(img_cvt))
    return img_cvt
```

å¦‚ä¸‹ä½¿ç”¨ç‰¹å¾do_features maskæ–¹å¼ï¼Œæ³¨æ„rb_rate=0.66çš„ä½¿ç”¨ï¼Œè¿™é‡Œä½¿ç”¨å®ƒç›®çš„æ˜¯ä½¿**ç‰¹å¾è¾¹ç¼˜å¹³æ»‘è¿‡æ¸¡**åˆ°å¼•å¯¼ç‰¹å¾ä¸­, å½“ç„¶è¿™é‡Œè¿˜å¯ä»¥æœ‰å„ç§ä¼˜åŒ–æ–¹å¼ï¼Œæ¯”å¦‚å‘ä¸‹è°ƒæ•´convd_median_factorä½¿åŸå§‹ç‰¹å¾è¾¹ç¼˜æå–æ›´åŠ åœ†æ¶¦å¹³æ»‘


```python
_ = mix_mask_with_convd(partial(do_features, loop_factor=1.1), '../prisma_gd/71758PICxSa_1024.jpg', 
                        '../prisma_gd/cx6.jpg', 'conv2/3x3_reduce', rb_rate=0.66, show=True)
```


![](http://upload-images.jianshu.io/upload_images/3136804-339bb4211a227d2f.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


[é£æ ¼å›¾åƒå±•ç¤ºå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODA4NTc1MzIuMjgwLjc4NjM3MzE1Njc1Mi8uL2N2dC5qcGc=)

å¦‚ä¸‹åº“æ—¥å¤©è¿™å¼ å›¾ä½¿ç”¨å‡å€¼å›å¤maskæ–¹å¼å¯ä»¥å¯¹å›¾ç‰‡äº§ç”Ÿæ¯”è¾ƒå¥½çš„æ•ˆæœï¼Œä½¿ç”¨å…¶å®ƒä¸¤ç§æ•ˆæœå‡ä¸ä½³ï¼Œè¯»è€…å¯è‡ªè¡Œæµ‹è¯•


```python
_ = mix_mask_with_convd(mask_stdmean_func, '../sample/kl.jpg', '../prisma_gd/cx7.jpg', 'conv2/3x3_reduce', 
                        n2=88, convd_median_factor=0.1, rb_rate=1, show=True)
```



![](http://upload-images.jianshu.io/upload_images/3136804-3d0de864c32c671e.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


![](http://upload-images.jianshu.io/upload_images/3136804-169c3714144a754c.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



[é£æ ¼å›¾åƒå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODA4NTc5MTcuMzcwLjcxOTAyMDMwOTMyOC8uL2N2dC5qcGc=)

ä¸‹é¢ç»§ç»­ä½¿ç”¨abuçš„ç…§ç‰‡ä½œä¸ºç¤ºä¾‹ï¼ˆè¿˜æ˜¯ç”¨abuçš„ç…§ç‰‡åšæ•ˆæœå¿ƒé‡Œæ¯”è¾ƒé«˜å…´ï¼Œå¦‚æœæ‚¨ä¸æƒ³å¤ªéº»çƒ¦æ­å»ºé£æ ¼ç”»çš„å¹³å°ï¼Œå¯ä»¥æŠŠç…§ç‰‡å‘ç»™æˆ‘ï¼Œç‰¹åˆ«æ˜¯**æ‚¨å®¶é‡Œçš„ç‹—ç‹—ï¼ŒçŒ«ï¼Œæˆ–è€…å°å­©å­çš„ç…§ç‰‡**ï¼‰

ä½¿ç”¨abu2çœ‹çœ‹ç°åœ¨çš„æ–¹å¼çš„è¿è¡Œæ•ˆç‡ï¼Œ%timeè®¡ç®—ä¸€ä¸‹è€—æ—¶ï¼Œè¯·æ³¨æ„å‚æ•°ï¼Œn3=1ï¼Œconvd_median_factor=0.2, convd_big_factor=0.0
ä¹Ÿå°±æ˜¯ä¸ä½¿ç”¨æœ€å¤§çš„å·ç§¯æ ¸äº†ï¼Œé€Ÿåº¦ä¼šéå¸¸å¿«, åªç”¨äº†5.62 sï¼Œè€Œä¸”è¿™ä¸ªé€Ÿåº¦è¿˜æ˜¯åšäº†ä¸€äº›å…¶å®ƒå·¥ä½œï¼Œå¦‚æ˜¾ç¤ºåŸå›¾ç­‰å·¥ä½œçš„æƒ…å†µä¸‹


```python
%time _ = mix_mask_with_convd(do_otsu, '../sample/abu2.jpg', '../prisma_gd/k5.jpg', 'conv2/3x3_reduce', n3=1, \
                        convd_median_factor=0.2, convd_big_factor=0.0, show=True)
```



![](http://upload-images.jianshu.io/upload_images/3136804-714d60329e407ed9.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![](http://upload-images.jianshu.io/upload_images/3136804-fc44a73623a92d9a.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


    CPU times: user 5.62 s, sys: 99.4 ms, total: 5.71 s
    Wall time: 4.2 s


[é£æ ¼å›¾åƒå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODA4NTczNTguNTYwLjE4NDk0MDA1MjM1NS8uL2N2dC5qcGc=)

abu5ä½¿ç”¨partial(together_mask_func, func_list=[do_otsu, mask_features_func]), ç»„åˆå¤šä¸ªç‰¹å¾æŠ½å–maskå‡½æ•°ï¼Œå¤šä¸ªæ»¤æ³¢å‡½æ•°ä»¥'ä¸çš„å…³ç³»'è¿›è¡Œç»„åˆï¼Œå¯¹å›¾åƒè¿›è¡Œmaskï¼Œè¿™é‡Œå¦‚æœä¸æ˜¯ç”¨together_mask_funcçš„è¯ï¼Œå•ç‹¬æ¯ä¸ªéƒ½è¦å†æ¬¡è°ƒæ•´ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚å•ç‹¬ä½¿ç”¨do_otsuï¼Œè¦è°ƒå¤§n2æ ¸çš„å¤§å°ï¼Œå½±å“é€Ÿåº¦ï¼Œmaskå‡½æ•°åˆå¹¶ç‰¹å¾å®Œç¾å¿«é€Ÿå®ç°äº†éœ€æ±‚


```python
tgt_mask_func = partial(together_mask_func, func_list=[do_otsu, mask_features_func])
_ = mix_mask_with_convd(tgt_mask_func, '../sample/abu3.jpg', '../prisma_gd/cx3.jpg', 'conv2/3x3_reduce', cb=False, 
                        n2=68, n3=1, convd_median_factor=1, convd_big_factor=0.0, show=True)
```



![](http://upload-images.jianshu.io/upload_images/3136804-549d2fd3796b155b.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![](http://upload-images.jianshu.io/upload_images/3136804-bca5f9fa8cb401a9.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


[é£æ ¼å›¾åƒå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODA4NTc0MTEuOTkwLjE3OTcyNjc4MjExMy8uL2N2dC5qcGc=)

### 5. é…åˆä½¿ç”¨é¢„å¤„ç†å›¾åƒå¢å¼ºï¼Œéšæœºrgbæµ…å±‚edgesç­‰å¢å¼ºprismaæ•ˆæœ

ä¸€ç”Ÿçš„å¶åƒè‰¾å¼—æ£®ï¼Œä½¿ç”¨**å›¾åƒé¢„å¤„ç†**çš„æ–¹å¼æ¥åšå›¾ï¼Œé¦–å…ˆç”¨Contrastçœ‹çœ‹ï¼Œæ³¨æ„è¿™é‡Œè®¾ç½®äº†å‚æ•°rb_rate=0.88ï¼Œçœ‹ä»£ç å®ƒçš„ä½œç”¨æ˜¯

        wn = []
        for _ in np.arange(0, rd_img.shape[0]):
            wn.append(np.random.binomial(1, rb_rate, rd_img.shape[1]))
        if rb_rate <> 1:
            rb_rate = rb_rate - 0.1
        w = np.stack(wn, axis=1)
        
		d_img = np.where(np.logical_or(
		         np.logical_and(clean_border_convd_median > convd_median_factor * clean_border_convd_big.mean(), w == 1),
		         np.logical_and(np.logical_and(clean_border_small > 0, w == 1), 
		                        clean_border_convd_big > convd_big_factor * clean_border_convd_big.mean(), 
		                        )), 
		         rd_img, gd_img)
        
* é€»è¾‘å’Œä¸­np.logical_andæ·»åŠ w == 1çš„åˆ¤æ–­ï¼Œ è¿™é‡Œä½¿ç”¨äºŒé¡¹å¼åˆ†å¸ƒï¼Œå¢å¼ºæ¸²æŸ“çš„è¿·å¹»æ•ˆæœï¼Œå³éšæœºåœ¨rgbæŸä¸€ä¸ªé€šé“ä¸­æ¸²æŸ“ä¸€ä¸‹å¼•å¯¼ç‰¹å¾
* rb_rate = rb_rate - 0.1 çš„ä½œç”¨æ˜¯3ä¸ªé€šé“çš„éšæœºæ¸²æŸ“æ¦‚ç‡é˜¶æ¢¯ä¸‹é™, è¿™é‡Œä¹Ÿå¯ä»¥æœ‰å…¶å®ƒå„ç§æ¸²æŸ“å˜ç§

å†å…·ä½“å½¢è±¡ç‚¹ä¸¾ä¾‹è¿™é‡Œçš„wäºŒé¡¹å¼åˆ†å¸ƒçŸ©é˜µå°±ç±»ä¼¼ä¸‹é¢è¿™ä¸ªç¤ºä¾‹çŸ©é˜µæ‰€ç¤ºï¼Œ0.8çš„æ¦‚ç‡ä¸º1
é’ˆå¯¹å›¾åƒä¸­æ¯ä¸€ä¸ªåƒç´ ç‚¹


```python
wn = []
for _ in np.arange(0, 20):
    wn.append(np.random.binomial(1, 0.8, 20))
w = np.stack(wn, axis=1)
w
```




    array([[1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
           [1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1],
           [1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0],
           [1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0],
           [1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1],
           [1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
           [1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1],
           [0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1],
           [1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 1],
           [1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0],
           [1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1],
           [0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1],
           [1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1],
           [1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0],
           [1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0],
           [1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
           [1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1],
           [1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1],
           [0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1],
           [1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1]])




```python
tgt_mask_func = partial(together_mask_func, func_list=[do_otsu, mask_stdmean_func])
_ = mix_mask_with_convd(tgt_mask_func, '../sample/lfs.jpg', '../prisma_gd/cx11.jpg', 
                        'conv2/norm2', enhance='Contrast', rb_rate=0.88, n2=180, n3=1,
                        convd_median_factor=0.01, convd_big_factor=0.0, show=True)
```



![](http://upload-images.jianshu.io/upload_images/3136804-02c300d3077de0ff.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![](http://upload-images.jianshu.io/upload_images/3136804-f786adc5734887a2.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


[é£æ ¼å›¾åƒå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODExMDQyNjkuNjAuNDE5NDg5NDYyNzQ2Ly4vY3Z0LmpwZw==)

æ„Ÿè§‰ä¸æ˜¯å¾ˆå¸…ï¼Œé‚£æ€ä¹ˆè¡Œï¼Œå‰ç½®ä¸€ä¸ªSharpnessé¢„å¤„ç†æ•ˆæœï¼Œçœ‹çœ‹


```python
_ = mix_mask_with_convd(do_otsu, '../sample/lfs.jpg', '../prisma_gd/cx11.jpg', 'conv2/norm2', 
                        enhance='Sharpness', rb_rate=0.88, cb=False, n2=188, n3=1,
                        convd_median_factor=0.01, convd_big_factor=0.0, show=True)
```



![](http://upload-images.jianshu.io/upload_images/3136804-87111edac2beedec.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



[é£æ ¼å›¾åƒå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODExMDQyNjkuNjAuNDE5NDg5NDYyNzQ2Ly4vY3Z0LmpwZw==)

ä¸Šé¢ä¸¤ä¸ªä½œå‡ºçš„æ•ˆæœï¼Œä»”ç»†è§‚å¯Ÿä½ ä¼šå‘ç°ï¼Œå…¶å®ä»–ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨å¼•å¯¼å›¾çš„sharpç‰¹å¾ï¼Œåªæ˜¯é€šè¿‡é˜¶æ¢¯rgbæ¸²æŸ“ï¼Œåœ¨åŸå§‹å›¾åƒä¸Šæ³¼ä¸Šäº†ä¸€å±‚æµ…å±‚çš„edgesç‰¹å¾ï¼Œè¿™æ ·çš„è¯
å®é™…ä¸Šä½ ä¸éœ€ä½¿ç”¨ä¸Šé¢è¿™ç§å®ç°æ–¹å¼ï¼Œæ³¨æ„mix_mask_with_convdçš„å‚æ•°all_maskï¼Œå½“all_maskä¸ºTrueæ—¶ï¼Œå°†æ•´ä¸ªå›¾åƒçš„maskå…¨è®¾ç½®255ï¼Œä»£ç å¦‚ä¸‹ï¼š

    clean_border_img = np.ones_like(l_img) * 255 if all_mask else do_mask_func(r_img=r_img, l_img=l_img, cb=cb)

æ‰€ä»¥å¦‚æœè¦ä½¿ç”¨æµ…å±‚ç‰¹å¾edgesç›´æ¥è®¾ç½®all_maskå°±ok

### 6. æœ€ç»ˆgitä¸Šå·¥ç¨‹ä»£ç å°è£…ç»“æ„åŠä½¿ç”¨ç¤ºä¾‹

å°†ä¸Šé¢çš„ä»£ç å†æ¬¡é‡æ„åˆ°æ–‡ä»¶PrismaWorkerä¸­, ä»£ç è¯¦æƒ…è¯·æŸ¥é˜…PrismaWorker.py


```python
from PrismaWorker import PrismaWorkerClass
```


```python
pw = PrismaWorkerClass()
```

ä¸‹é¢ä½¿ç”¨ä¸¤ä¸ªGTA5çš„å›¾ç‰‡ï¼Œèåˆæ‘©æ‰˜è½¦å¤§å“¥åˆ°å¤§éƒ¨é˜Ÿä¸­

å¦‚ä¸‹ä¸ºå¼•å¯¼ç‰¹å¾å›¾


```python
pw.cp.resize_img(PIL.Image.open('../prisma_gd/gta2.jpg'), base_width=480, keep_size=False)
```



![](http://upload-images.jianshu.io/upload_images/3136804-9c311c53fbe2b016.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)




æ³¨æ„partial(do_otsu, dd=False)ä¸­çš„ddå‚æ•°ä»£è¡¨otsuåå–å†…éƒ¨è¿˜æ˜¯åå‘çš„å¤–éƒ¨ï¼Œå¦‚ä¸‹çš„é»‘ç™½maskå›¾ï¼Œdd=Falseå¯ä»¥å–åˆ°éª‘æ‰‹ï¼Œå¦åˆ™å°†å–åˆ°å¤–éƒ¨èƒŒæ™¯


```python
_ = pw.mix_mask_with_convd(partial(pw.do_otsu, dd=False), '../sample/gta4.jpg', '../prisma_gd/gta2.jpg', 'conv2/3x3_reduce', 
                           enhance='Sharpness',  n2=88, n3=1, 
                           convd_median_factor=1.5, convd_big_factor=0.0, show=True)
```



![](http://upload-images.jianshu.io/upload_images/3136804-5ffa5334c5e6cfe5.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![](http://upload-images.jianshu.io/upload_images/3136804-3ad2873cc714a167.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


![](http://upload-images.jianshu.io/upload_images/3136804-6ee98ba5512d7f0d.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



[é£æ ¼å›¾åƒå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODA4NTc4MzcuOTAuODU0NTA0NjMzNDM0Ly4vY3Z0LmpwZw==)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ•ˆæœè¿˜ç®—ä¸é”™ï¼Œé™¤äº†å·¦ä¸‹è„šä¸¤ä¸ªæ ‡å‡†çš„é‡å 

æ¥ä¸‹æ¥ä½¿ç”¨æ‰¹é‡å¤„ç†å¼•å¯¼å›¾åƒï¼Œé¢„å¤„ç†ï¼Œç‰¹å¾æ”¾å¤§å±‚ç­‰å‚æ•°æ’åˆ—ç»„åˆä½¿ç”¨PrismaMasterï¼Œè¯¦æƒ…æŸ¥è¯¢ä»£ç PrismaMaster.py

å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œå¯ä»¥ç”Ÿæˆæ‰€æœ‰å‚æ•°æ’åˆ—ç»„åˆçš„è¾“å‡ºç»“æœ


```python
import PrismaMaster
cb=False
n1 = 5
n2=38
n3=1
convd_median_factor=0.6
convd_big_factor=0.0
loop_factor = 1.0
std_factor = 0.88

nbk_list = filter(lambda nbk: nbk[-8:-1] <> '_split_', cp.net.blobs.keys()[1:-2])[:10]
org_file_list = ['../sample/bz1.jpg']
gd_file_list = [None, '../cx/cx3.jpg', '../cx/cx6.jpg', '../cx/cx7.jpg','../cx/cx10.jpg']
enhance_list = [None, 'Sharpness', 'Contrast']
rb_rate_list = [0.85, 1.0]
    
save_dir = '../out/2016_11_24'
PrismaMaster.product_prisma(org_file_list, gd_file_list, nbk_list, enhance_list, rb_rate_list, 'otsu_func',
                            n1, n2, n3, std_factor, loop_factor, convd_median_factor, 
                            convd_median_factor, cb, save_dir)
```

è¾“å‡ºçš„å›¾åƒå¯ä»¥ä»ä¸­é€‰æ‹©å–œæ¬¢çš„ï¼Œä¸å¿…ä¸€ä¸ªä¸ªçš„è¯•æ•ˆæœäº†


![](http://upload-images.jianshu.io/upload_images/3136804-9bac7eee3f070968.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


æ¥ä¸‹æ¥å†åšä¸€ä¸ªguiçš„å¯è§†åŒ–æ“ä½œç•Œé¢PrismaController, ä½¿ç”¨äº†traitsuiåº“ï¼Œè¯¦æƒ…æŸ¥çœ‹äº†PrismaController.py

å…·ä½“ä½¿ç”¨æ–¹å¼è¯·å‚çœ‹ [youku é˜¿å¸ƒPrismaæ¼”ç¤ºè§†é¢‘](http://v.youku.com/v_show/id_XMTg0MDE3NTM3Mg==.html)


![](http://upload-images.jianshu.io/upload_images/3136804-5c2e54ac6d9ff03f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


åŸºäºè¿™æ ·ä¸€ä¸ªæ–¹ä¾¿å¾®è°ƒçš„guiä¸‹å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯¹å›¾åƒè¿›è¡Œå¾®è°ƒï¼Œéå¸¸å®¹æ˜“çš„åšå‡ºå¾ˆå¤šé…·ç‚«å±Œç‚¸çš„å›¾åƒï¼Œæ¯”å¦‚ä¸‹é¢åšçš„ä¸¤å¼ åŸºäºGTAé£æ ¼çš„å›¾åƒ


![](http://upload-images.jianshu.io/upload_images/3136804-1ee95697ecec5ff9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


[é£æ ¼å›¾åƒå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODA4NTc4NDguMzQwLjYyNDU3OTQ1MTIyOS8uL2N2dC5qcGc=)


![](http://upload-images.jianshu.io/upload_images/3136804-5a20a7e54a90db68.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


[é£æ ¼å›¾åƒå¢™ä¸­åœ°å€](http://www.yabeetu.com/design/L3N0YXRpYy90ZW1wLzE0ODA4NTc4NjMuNjIwLjIzMTU5OTUwMDQ5Ny8uL2N2dC5qcGc=)

ä¸Šé¢è¿™å¼ çŠ€åˆ©å“¥å’ŒGTA5åˆä½“çš„åŸå›¾å’Œå¼•å¯¼ç‰¹å¾å›¾å¦‚ä¸‹


```python
fig, axs = plt.subplots(nrows=1, ncols=2, figsize=(20, 10));
up_list = ['../sample/xlg.jpg', '../prisma_gd/gta1.jpg']
for ind, ax in zip(range(1 * 2), axs):
    iter_fn = up_list[ind]
    iter_img = plt.imread(iter_fn)
    # ax.set_title(os.path.basename(iter_fn))
    ax.imshow(iter_img);
    ax.set_axis_off()
```


![](http://upload-images.jianshu.io/upload_images/3136804-f8c34fd6874f684d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



å¦‚æœä½ ä¸çŸ¥é“ä»€ä¹ˆæ ·æ•ˆæœæœ€å¥½æˆ–è€…æƒ³è¦æ‰€æœ‰å¯èƒ½çš„æ•ˆæœå›¾ï¼Œä½ å¯ä»¥çœ‹åˆ°guiçš„ç•Œé¢ä¸Šè¿˜æœ‰ä¸ªæŒ‰é’®â€˜ä½¿ç”¨å‚æ•°æ‰¹é‡è‰ºæœ¯å›¾ç‰‡â€™ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä½¿ç”¨åˆšåˆšè°ƒæ•´å¥½çš„n1, n2, dd......ç­‰ç­‰å‚æ•°ä½œä¸ºå›ºå®šå‚æ•°ï¼Œå¼•å¯¼ç‰¹å¾å›¾ï¼Œæ”¾å¤§å±‚ç‰¹å¾ï¼Œé¢„å¤„ç†å¢å¼ºç­‰ç­‰ä½œä¸ºæ‰€æœ‰å¯èƒ½çš„æ’åˆ—ç»„åˆï¼Œé€šè¿‡ä¸€é”®ç”Ÿæˆå‡ ç™¾ä¸Šåƒå¼ çš„é£æ ¼å›¾åƒï¼Œä»£ç è¯¦æƒ…æŸ¥çœ‹äº†PrismaController.py

    def _master_img_fired(self):
        nbk_list = ['conv2/3x3_reduce', 'conv2/3x3', 'conv2/norm2'] if g_use_min_batch_set else filter(
            lambda nbk: nbk[-8:-1] <> '_split_',
            self.prisma_worker.cp.net.blobs.keys()[1:-2])[:10]

        org_file_list = [self.org_file]

        gd_file_list = glob.glob('../prisma_gd/*.jpg')
        if g_use_min_batch_set:
            """
                å°æ•°æ®é›†åªå– sm*.jpg
            """
            gd_file_list = filter(lambda fn: os.path.basename(fn).startswith('sm'), gd_file_list)
        # gd_file_list.insert(0, None)

        enhance_list = [None, 'Sharpness', 'Contrast'] if g_use_min_batch_set else [None, 'Sharpness', 'Contrast', 'CONTOUR']

        rb_rate_list = [1.0] if g_use_min_batch_set else [0.88, 1.0]

        # all_mask = self.all_mask
        all_mask = True

        save_dir = '../out/' + str(datetime.date.today())[:10]
        PrismaMaster.product_prisma(org_file_list, gd_file_list, nbk_list, enhance_list, rb_rate_list,
                                    self.mask_enum, self.n1_convd, self.n2_convd, self.n3_convd, self.dd,
                                    self.stdmean_func_factor, self.features_func_factor, self.convd_median_factor,
                                    self.convd_big_factor, self.cb, all_mask, save_dir)

æ­å»ºé£æ ¼ç”»çš„å¹³å°éœ€è¦ç¯å¢ƒç¡®å®æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰åšä¸€ä¸ªpipå®‰è£…å·¥å…·ï¼ŒåæœŸæˆ‘çœ‹éœ€æ±‚æƒ…å†µå§

å¦‚æœæ‚¨ä¸æƒ³å¤ªéº»çƒ¦æ­å»ºé£æ ¼ç”»çš„å¹³å°ï¼Œå¯ä»¥æŠŠéœ€è¦å¤„ç†çš„å›¾åƒç…§ç‰‡å‘ç»™æˆ‘ï¼Œç‰¹åˆ«æ˜¯**æ‚¨å®¶é‡Œçš„ç‹—ç‹—ï¼ŒçŒ«ï¼Œæˆ–è€…å°å­©å­çš„ç…§ç‰‡**ï¼Œæˆ‘ä¼šå¾ˆå¼€å¿ƒçš„ä¸ºä»–ä»¬åˆ¶ä½œè‰ºæœ¯é£æ ¼ç…§ç‰‡çš„

æœ¬ç« åè®°ï¼š

1. æœ¬æ–‡æ‰€è®²çš„è¿™ç§å®ç°prismaçš„æ–¹å¼ï¼Œä¸ä»£è¡¨ä»»ä½•çœŸå®æƒ…å†µï¼Œåªæ˜¯ä¸€ç§å¯èƒ½çš„æŠ€æœ¯å®ç°æ€è·¯ï¼Œå¹¶ä¸”åœ¨è¿™ç§æ€è·¯ä¸‹è¿˜éœ€è¦åšå¾ˆå¤šçš„å·¥ä½œï¼Œæ¯”å¦‚é’ˆå¯¹é€‚ç”¨æ€§çš„é—®é¢˜ä¹Ÿè®¸è¦ä¿å­˜å¤§é‡å­—å…¸ï¼Œå­—å…¸çš„keyå¯ä»¥æ˜¯å›¾åƒçŸ©é˜µç‰¹å¾ï¼Œvalueå¯¹åº”ç€å¤„ç†å‚æ•°ï¼Œç„¶åé’ˆå¯¹è¾“å…¥çš„å›¾åƒè¿›è¡Œåˆ†ç±»æˆ–è€…ç‰¹å¾ç›¸ä¼¼åº¦åŒ¹é…æ¥è®¤å®šè¯¥ä½¿ç”¨é‚£äº›å‚æ•°ç­‰ç­‰å¤æ‚é—®é¢˜éœ€è¦å¤„ç†ã€‚

2. æœ¬æ–‡gitä¸Šçš„ä»£ç å¹¶æ²¡æœ‰è¿‡å¤šå…³å¿ƒä»£ç è¿è¡Œæ•ˆç‡ç­‰é—®é¢˜ï¼Œæ¯”å¦‚é’ˆå¯¹å›¾åƒä¿å­˜ï¼Œè¯»å–scipy.miscæ¯”ç”¨PILçš„å®ç°æ–¹å¼æ•ˆç‡è¦é«˜å¾ˆå¤šï¼Œä½†ä¸ºäº†ä»£ç å¯è¯»æ€§ï¼Œè¿™é‡Œé€‰æ‹©ä½¿ç”¨PIL

### æ„Ÿè°¢ğŸ™æ‚¨èƒ½æœ‰è€å¿ƒçœ‹åˆ°è¿™é‡Œ
### å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥å…³æ³¨é˜¿å¸ƒçš„å¾®ä¿¡ 
### å¾®ä¿¡å·ï¼šaaaabbbuu


![](http://upload-images.jianshu.io/upload_images/3136804-c7eaa714fdb5b493.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

